{% extends "Navbar.html" %}
{% block content %}
<div class="container mt-5">

  <h2 class="text-center mb-4">Malaria Detection</h2>

  <!-- Upload Form -->
  <div class="card shadow border-0">
    <div class="card-body p-4">
      <form action="{{ url_for('predict') }}" method="post" enctype="multipart/form-data">
        <div class="mb-3">
          <label for="file" class="form-label">Upload Blood Cell Image</label>
          <div id="dropzone" class="p-4 border rounded-3 text-center bg-light">
            <div class="mb-2">Drag & drop image here, or click to browse</div>
            <input class="form-control" type="file" name="file" id="file" accept="image/*" style="display:none" required>
            <button type="button" id="browseBtn" class="btn btn-outline-secondary btn-sm">Choose File</button>
          </div>
          <!-- Preview -->
          <div class="mt-3" id="previewContainer" style="display:none;">
            <h6>Preview:</h6>
            <img id="previewImage" alt="Preview" class="img-fluid rounded border" />
          </div>
        </div>
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-success">Predict</button>
          <button type="button" id="clearBtn" class="btn btn-outline-secondary">Clear</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Prediction Result -->
  {% if result %}
  <div class="card mt-4 shadow-sm">
    <div class="card-body">
      <h5 class="card-title">Prediction Result</h5>
      <p><strong>Prediction:</strong> {{ result.prediction }}</p>
      <p><strong>Confidence:</strong> {{ result.confidence * 100 }}%</p>
      <p><strong>Description:</strong> {{ result.description }}</p>
      <p><strong>Note:</strong> {{ result.note }}</p>
    </div>
  </div>
  {% endif %}

  <!-- Uploaded & Processed Images -->
  <div class="row mt-4">
    {% if uploaded_img %}
    <div class="col-md-6">
      <h5>Uploaded Image</h5>
      <img src="{{ url_for('static', filename='uploads/' ~ uploaded_img) }}" class="img-fluid rounded shadow">
    </div>
    {% endif %}
    {% if processed_img %}
    <div class="col-md-6">
      <h5>Processed Image</h5>
      <img src="{{ url_for('static', filename='uploads/' ~ processed_img) }}" class="img-fluid rounded shadow">
    </div>
    {% endif %}
  </div>

</div>

<!-- JavaScript for preview & drag/drop -->
<script>
  const fileInput = document.getElementById("file");
  const browseBtn = document.getElementById("browseBtn");
  const dropzone = document.getElementById("dropzone");
  const previewContainer = document.getElementById("previewContainer");
  const previewImage = document.getElementById("previewImage");
  const clearBtn = document.getElementById("clearBtn");

  // Browse button
  browseBtn.addEventListener("click", () => fileInput.click());

  // Show preview
  fileInput.addEventListener("change", () => {
    if (fileInput.files && fileInput.files[0]) {
      const reader = new FileReader();
      reader.onload = e => {
        previewImage.src = e.target.result;
        previewContainer.style.display = "block";
      };
      reader.readAsDataURL(fileInput.files[0]);
    }
  });

  // Drag & drop
  dropzone.addEventListener("dragover", e => {
    e.preventDefault();
    dropzone.classList.add("border-primary");
  });
  dropzone.addEventListener("dragleave", () => {
    dropzone.classList.remove("border-primary");
  });
  dropzone.addEventListener("drop", e => {
    e.preventDefault();
    dropzone.classList.remove("border-primary");
    fileInput.files = e.dataTransfer.files;
    const reader = new FileReader();
    reader.onload = ev => {
      previewImage.src = ev.target.result;
      previewContainer.style.display = "block";
    };
    reader.readAsDataURL(fileInput.files[0]);
  });

  // Clear selection
  clearBtn.addEventListener("click", () => {
    fileInput.value = "";
    previewImage.src = "";
    previewContainer.style.display = "none";
  });
</script>
{% endblock %}
